name: Release Build

# Triggered by: unitune-app/create-release.ps1  →  git push origin vX.Y.Z
#
# What this workflow does:
#  1. Parses CHANGELOG.md (scripts/parse-changelog.js) → version JSON
#  2. Builds Android APK (DISTRIBUTION_CHANNEL=github) — debug-signed, for GitHub sideload
#  3. Creates a GitHub Release with the APK + changelog body
#  4. Triggers the worker deploy workflow with the version JSON so the
#     worker immediately serves the new What's New data
#
# AAB (Play Store) is built locally:
#   flutter build appbundle --release --dart-define=DISTRIBUTION_CHANNEL=playstore
# iOS: not built in CI, irrelevant.
#
# Required GitHub Secrets (Settings → Secrets → Actions):
#   WORKER_REPO_TOKEN  — PAT with `workflow` scope on the worker repo

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

env:
  FLUTTER_VERSION: '3.38.6'
  JAVA_VERSION: '17'
  WORKER_REPO: 'FlazeIGuess/unitune-worker'

jobs:
  # ── Step 1: Parse the changelog once, share output to other jobs ──────────
  parse-changelog:
    name: Parse CHANGELOG
    runs-on: ubuntu-latest
    outputs:
      version_json: ${{ steps.parse.outputs.version_json }}
      version:      ${{ steps.parse.outputs.version }}
      build:        ${{ steps.parse.outputs.build }}
    steps:
    - uses: actions/checkout@v4

    - name: Parse CHANGELOG.md and pubspec.yaml
      id: parse
      run: |
        VERSION_JSON=$(node scripts/parse-changelog.js)
        echo "version_json=$VERSION_JSON" >> $GITHUB_OUTPUT
        echo "version=$(echo $VERSION_JSON | node -e "let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>process.stdout.write(JSON.parse(d).latest_version))")" >> $GITHUB_OUTPUT
        echo "build=$(echo $VERSION_JSON   | node -e "let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>process.stdout.write(String(JSON.parse(d).latest_build)))")" >> $GITHUB_OUTPUT

  # ── Step 2: Build Android APK (GitHub sideload channel) ─────────────────
  build-android-apk:
    name: Build Android APK (GitHub)
    runs-on: ubuntu-latest
    needs: parse-changelog
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}

    - uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    # No keystore setup — build.gradle.kts falls back to debug signing
    # when key.properties is absent. Debug-signed APKs are fine for sideloading.

    - name: Get dependencies
      run: flutter pub get

    - name: Build APK (GitHub channel)
      run: flutter build apk --release --dart-define=DISTRIBUTION_CHANNEL=github

    - name: Rename artifact
      run: |
        mv build/app/outputs/flutter-apk/app-release.apk \
           build/app/outputs/flutter-apk/UniTune-${{ needs.parse-changelog.outputs.version }}-github.apk

    - uses: actions/upload-artifact@v4
      with:
        name: apk-github
        path: build/app/outputs/flutter-apk/UniTune-*.apk
        retention-days: 7

  # ── Step 3: Create GitHub Release + trigger worker deploy ─────────────────
  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [parse-changelog, build-android-apk]
    steps:
    - uses: actions/checkout@v4

    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: Extract What's New for release body
      id: body
      run: |
        VERSION="${{ needs.parse-changelog.outputs.version }}"
        BUILD="${{ needs.parse-changelog.outputs.build }}"
        WHATS_NEW=$(echo '${{ needs.parse-changelog.outputs.version_json }}' | node -e "
          let d='';
          process.stdin.on('data',c=>d+=c);
          process.stdin.on('end',()=>{
            const p=JSON.parse(d);
            const lines=p.whats_new.map(i=>'- **'+i.title+'** — '+i.body).join('\n');
            process.stdout.write(lines);
          });
        ")
        CHANGELOG_URL="https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md"
        BODY="## UniTune v${VERSION} (build ${BUILD})

        ### What's New
        ${WHATS_NEW}

        ### Downloads
        | File | Description |
        |------|-------------|
        | \`UniTune-${VERSION}-github.apk\` | Android — direct install (sideload) |

        > Play Store AAB is built and uploaded locally.

        ### Full Changelog
        See [CHANGELOG.md](${CHANGELOG_URL}) for the complete list of changes."

        printf '%s' "$BODY" > release-body.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.parse-changelog.outputs.version }}
        name: UniTune v${{ needs.parse-changelog.outputs.version }}
        body_path: release-body.md
        draft: false
        prerelease: false
        files: |
          release-artifacts/apk-github/UniTune-*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Trigger the worker repo to deploy with the new version data.
    # Requires: WORKER_REPO_TOKEN = PAT with "workflow" scope on unitune-worker repo.
    - name: Trigger Worker Deploy with new version data
      run: |
        gh workflow run deploy.yml \
          --repo "${{ env.WORKER_REPO }}" \
          --ref main \
          --field version_json='${{ needs.parse-changelog.outputs.version_json }}'
      env:
        GH_TOKEN: ${{ secrets.WORKER_REPO_TOKEN }}

